<!DOCTYPE HTML>
<head>
	<title>Tellweb</title>
	<link rel="stylesheet" href="styles.css">
	<meta name="viewport" content="width=device-width, initial-scale=1"/>
</head>
<body>
	<div class="login">
		<p class="title">Tellweb</p>
		<input class="name" id="name" placeholder="Name">
		<p id="info">Name is only required only if you're registering.</p>
		<input class="username" id="username" placeholder="Username">
		<input class="password" id="password" type="password" placeholder="Password">
		<img src="https://antibotcc0.pythonanywhere.com/captcha.png">
		<input id="captcha" placeholder="CAPTCHA Answer">
		<button class="loginBtn" id="loginButton">Log In / Register</button>
		<p class="error" hidden="true" id="error" class="error"></p>
		<div class="loader" id="loader" hidden="true"></div>
	</div>
</body>
<script src="web.js"></script>
<script>
	async function authComplete(){
		return typeof localStorage.user_id == "undefined";
	}

	async function isLoggedIn(response){
		if(response.startsWith("state.LOGIN.TRUE") || response.startsWith("state.REGISTER.TRUE")){
			return true;
		}
	}

	async function whenLoaded(){
		let auth_c = await authComplete();
		if(!auth_c){
			window.location.href = window.location.origin + "/chats";
		}
	}

	async function loginHandler(){
		let username = document.querySelector("#username").value;
		let password = document.querySelector("#password").value;
		let name = document.querySelector("#name").value;
		document.getElementById("loader").hidden = false;
		let response = await tellweb.logAction(username, password, document.getElementById("captcha").value, name);
		document.getElementById("loader").hidden = true;
		if(response == "state.NAME_INVALID"){
			document.getElementById("name").hidden = false;
			document.getElementById("info").hidden = false;
			document.getElementById("error").hidden = true;
		}else{
			if(isLoggedIn(response) && response != "state.LOGIN.FALSE -1 null" && response != "state.CAPTCHA_INVALID"){
				document.getElementById("error").hidden = true;
				document.getElementById("error").innerText = "";
				let auth = response.split(" ");
				localStorage.setItem("user_id", auth[1]);
				localStorage.setItem("session", auth[2]);
				if(response.startsWith("state.REGISTER.TRUE")){
					localStorage.setItem("registered", password);
				}
				if(response.startsWith("state.LOGIN.TRUE")){
					localStorage.setItem("login", password); // saved temporarily
				}
				window.location.href = window.location.origin + "/chats";
			}else{
				document.getElementById("error").hidden = false;
				if(response == "state.LOGIN.FALSE -1 null"){
					document.getElementById("error").innerText = "Logging in failed.";
				}else{
					document.getElementById("error").innerText = response;
				}
			}
		}
	}

	document.querySelector("#loginButton").addEventListener("click", loginHandler);
	if(window.addEventListener){
		window.addEventListener('load', whenLoaded, false);
	}else{
		window.attachEvent('onload', whenLoaded);
	}
</script>